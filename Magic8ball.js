const display = require("display");
const keyboard = require("keyboard");

const displayWidth = display.width();
const displayHeight = display.height();

const bgColor = BRUCE_BGCOLOR;
const priColor = BRUCE_PRICOLOR;
const secColor = BRUCE_SECCOLOR;

function renderBitmap(x, y, bitmap, width, height, color, bgColor) {
    var data = new Uint8Array(bitmap);
    var byteWidth = Math.floor((width + 7) / 8);

    for (var j = 0; j < height; j++) {
        for (var i = 0; i < width; i++) {
            var byteIndex = j * byteWidth + Math.floor(i / 8);
            var bitIndex = i % 8;
            var pixel = (data[byteIndex] >> bitIndex) & 1;

            if (pixel) {
                display.drawPixel(x + i, y + j, color);
            } else if (bgColor !== undefined) {
                display.drawPixel(x + i, y + j, bgColor);
            }
        }
    }
}

const ball8 = new Uint8Array([0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xFC, 0xF8, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x7E, 0xF8, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x3F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x80, 0x1F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0xC0, 0x87, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0xE0, 0xC3, 0xFF, 0x0F, 0xF0, 0xFF, 0xFF, 0x07, 0xE0, 0xE3, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0x07, 0xF0, 0xE1, 0x7F, 0x00, 0x00, 0xFE, 0xFF, 0x0F, 0xF8, 0xF0, 0x1F, 0x00, 0x00, 0xF8, 0xFF, 0x1F, 0xF8, 0xF8, 0x0F, 0x00, 0x00, 0xF0, 0xFF, 0x1F, 0x78, 0xF8, 0x07, 0x00, 0x00, 0xE0, 0xFF, 0x1F, 0x7C, 0xFC, 0x03, 0xC0, 0x07, 0xC0, 0xFF, 0x3F, 0x3C, 0xFC, 0x01, 0xF0, 0x1F, 0x80, 0xFF, 0x3F, 0x3E, 0xFE, 0x01, 0x7C, 0x3E, 0x80, 0xFF, 0x7F, 0x1E, 0xFE, 0x00, 0x1C, 0x38, 0x00, 0xFF, 0x7F, 0x1E, 0xFF, 0x00, 0x0E, 0x70, 0x00, 0xFF, 0x7F, 0x1E, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0x7F, 0x0F, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0xFF, 0x8F, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0xFF, 0x8F, 0x3F, 0x00, 0x1C, 0x38, 0x00, 0xFC, 0xFF, 0x8F, 0x3F, 0x00, 0x3C, 0x1C, 0x00, 0xFC, 0xFF, 0x8F, 0x3F, 0x00, 0xF8, 0x0F, 0x00, 0xFC, 0xE7, 0x8F, 0x3F, 0x00, 0xF0, 0x0F, 0x00, 0xFC, 0xC7, 0x8F, 0x3F, 0x00, 0xF8, 0x1F, 0x00, 0xFC, 0xE7, 0xCF, 0x3F, 0x00, 0x1C, 0x3C, 0x00, 0xFC, 0xE7, 0xFF, 0x3F, 0x00, 0x0E, 0x78, 0x00, 0xFC, 0xE7, 0xFF, 0x3F, 0x00, 0x0E, 0x70, 0x00, 0xFC, 0xE7, 0xFF, 0x7F, 0x00, 0x07, 0xF0, 0x00, 0xFE, 0xE7, 0xFF, 0x7F, 0x00, 0x07, 0xE0, 0x00, 0xFE, 0xE3, 0xFE, 0x7F, 0x00, 0x0F, 0xF0, 0x00, 0xFE, 0x63, 0xFE, 0xFF, 0x00, 0x0E, 0x70, 0x00, 0xFF, 0x73, 0xFE, 0xFF, 0x00, 0x1E, 0x78, 0x00, 0xFF, 0x71, 0xFE, 0xFF, 0x01, 0x7C, 0x3E, 0x80, 0xFF, 0x71, 0xFC, 0xFF, 0x01, 0xF8, 0x1F, 0x80, 0xFF, 0x39, 0xFC, 0xFF, 0x03, 0xE0, 0x07, 0xC0, 0xFF, 0x38, 0xF8, 0xFF, 0x07, 0x00, 0x00, 0xE0, 0xFF, 0x1C, 0xF8, 0xFF, 0x0F, 0x00, 0x00, 0xF0, 0x7F, 0x1C, 0xF8, 0xFF, 0x1F, 0x00, 0x00, 0xF8, 0x3F, 0x1E, 0xF0, 0xFF, 0x7F, 0x00, 0x00, 0xFE, 0x3F, 0x0F, 0xE0, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0x07, 0xE0, 0xFF, 0xFF, 0x0F, 0xF0, 0xFF, 0xFF, 0x07, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00]).buffer;
const ball8thinking = new Uint8Array([0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x3F, 0xC0, 0xFF, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0x3F, 0x00, 0xFE, 0x03, 0x00, 0x00, 0xE0, 0xFF, 0x7F, 0x00, 0xF8, 0x07, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0x1F, 0xE0, 0x1F, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x80, 0x3F, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0x03, 0x7F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xFC, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xF8, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xF0, 0x01, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE1, 0x03, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x87, 0x07, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFC, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFC, 0xF8, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0xF8, 0xE1, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xE0, 0x03, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xC0, 0x0F, 0xF8, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFC, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x01, 0xFC, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFE, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00]).buffer;

const affirmative = ["It is certain", "It is decidedly so", "Without a doubt", "Yes definitely", "You may rely on it", "As I see it, yes", "Most likely", "Outlook good", "Yes", "Signs point to yes"];
const nonCommittal = ["Reply hazy, try again", "Ask again later", "Better not tell you now", "Cannot predict now", "Concentrate and ask again"];
const negative = ["Don't count on it", "My reply is no", "My sources say no", "Outlook not so good", "Very doubtful"];
const allAnswers = affirmative.concat(nonCommittal, negative);

function getRandomAnswer() {
    return allAnswers[Math.floor(Math.random() * allAnswers.length)];
}

function drawTitle() {
    display.fill(bgColor);
    display.drawRoundRect(1, 1, displayWidth - 2, displayHeight - 2, 4, priColor);
    display.setTextColor(priColor);
    display.setTextSize(2);
    const title = "Magic 8 Ball";
    const charWidth = 6 * 2;
    const x = (displayWidth - title.length * charWidth) / 2;
    display.drawString(title, x, 10);
    display.setTextSize(1);
}

function drawBall8(image, color) {
    const BALL_SIZE = 64;
    const x = Math.round(displayWidth * 0.2 - BALL_SIZE / 2);
    const y = Math.round((displayHeight - BALL_SIZE) / 2);
    // display.drawXBitmap(x, y, image, BALL_SIZE, BALL_SIZE, color, bgColor);
    renderBitmap(x, y, image, BALL_SIZE, BALL_SIZE, color, bgColor);
    return {x: x, y: y, size: BALL_SIZE};
}

function pressSelForNext() {
    display.setTextSize(1);
    const msg = "Press SEL for next";
    const charWidth = 6; // size 1
    const rightMargin = 10;
    const bottomMargin = 20;
    const x = displayWidth - rightMargin - msg.length * charWidth;
    const y = displayHeight - bottomMargin;
    display.drawString(msg, x, y);
}

function showInstructions() {
    drawTitle();
    const b = drawBall8(ball8, priColor);
    display.setTextSize(3);
    const line1 = "Ask a";
    const line2 = "question";
    const charWidth = 6 * 3;
    const lineHeight = 24;
    const totalHeight = lineHeight * 2;
    const startY = b.y + Math.round((b.size - totalHeight) / 2);
    const textX = Math.min(b.x + b.size + 12,
        displayWidth - 10 - Math.max(line1.length, line2.length) * charWidth);
    display.drawString(line1, textX, startY);
    display.drawString(line2, textX, startY + lineHeight);
    pressSelForNext();
}

function showThinking() {
    drawTitle();
    const b = drawBall8(ball8thinking, secColor);
    display.setTextSize(3);
    display.setTextColor(secColor);
    const textX = Math.min(b.x + b.size + 12, displayWidth - 180);
    const textY = b.y + Math.round((b.size - 24) / 2);
    display.drawString("Thinking...", textX, textY);
    display.setTextColor(priColor);
}


function showAnswer(answer) {
    drawTitle();
    const b = drawBall8(ball8, priColor);

    const FONT_SIZE = 3;
    display.setTextSize(FONT_SIZE);

    const margin = 12;
    const textX = Math.min(b.x + b.size + margin, displayWidth - 20);
    const availableWidth = Math.max(0, displayWidth - textX - 10);

    const charWidth = 6 * FONT_SIZE;
    const lineHeight = 8 * FONT_SIZE;
    const maxCharsPerLine = Math.max(1, Math.floor(availableWidth / charWidth));

    const words = answer.split(' ');
    const lines = [];
    var current = "";
    for (var i = 0; i < words.length; i++) {
        const test = current ? (current + " " + words[i]) : words[i];
        if (test.length > maxCharsPerLine && current) {
            lines.push(current);
            current = words[i];
        } else {
            current = test;
        }
    }
    if (current) lines.push(current);

    const totalHeight = lines.length * lineHeight;
    const startY = b.y + Math.max(0, Math.round((b.size - totalHeight) / 2));

    for (var l = 0; l < lines.length; l++) {
        display.drawString(lines[l], textX, startY + l * lineHeight);
    }

    pressSelForNext();
}

showInstructions();

while (true) {
    if (keyboard.getSelPress()) {
        showThinking();
        delay(1000);
        const answer = getRandomAnswer();
        showAnswer(answer);
        while (!keyboard.getSelPress()) {
            if (keyboard.getEscPress()) break;
            delay(100);
        }
        if (keyboard.getEscPress()) break;
        showInstructions();
    }
    if (keyboard.getEscPress()) break;
    delay(100);
}