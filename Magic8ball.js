var display = require("display");

var displayWidth = display.width();
var displayHeight = display.height();

var bgColor = BRUCE_BGCOLOR;
var priColor = BRUCE_PRICOLOR;
var secColor = BRUCE_SECCOLOR;

var ball8 = new Uint8Array([0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xFC, 0xF8, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x7E, 0xF8, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x3F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x80, 0x1F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0xC0, 0x87, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0xE0, 0xC3, 0xFF, 0x0F, 0xF0, 0xFF, 0xFF, 0x07, 0xE0, 0xE3, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0x07, 0xF0, 0xE1, 0x7F, 0x00, 0x00, 0xFE, 0xFF, 0x0F, 0xF8, 0xF0, 0x1F, 0x00, 0x00, 0xF8, 0xFF, 0x1F, 0xF8, 0xF8, 0x0F, 0x00, 0x00, 0xF0, 0xFF, 0x1F, 0x78, 0xF8, 0x07, 0x00, 0x00, 0xE0, 0xFF, 0x1F, 0x7C, 0xFC, 0x03, 0xC0, 0x07, 0xC0, 0xFF, 0x3F, 0x3C, 0xFC, 0x01, 0xF0, 0x1F, 0x80, 0xFF, 0x3F, 0x3E, 0xFE, 0x01, 0x7C, 0x3E, 0x80, 0xFF, 0x7F, 0x1E, 0xFE, 0x00, 0x1C, 0x38, 0x00, 0xFF, 0x7F, 0x1E, 0xFF, 0x00, 0x0E, 0x70, 0x00, 0xFF, 0x7F, 0x1E, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0x7F, 0x0F, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0xFF, 0x8F, 0x7F, 0x00, 0x0E, 0x70, 0x00, 0xFE, 0xFF, 0x8F, 0x3F, 0x00, 0x1C, 0x38, 0x00, 0xFC, 0xFF, 0x8F, 0x3F, 0x00, 0x3C, 0x1C, 0x00, 0xFC, 0xFF, 0x8F, 0x3F, 0x00, 0xF8, 0x0F, 0x00, 0xFC, 0xE7, 0x8F, 0x3F, 0x00, 0xF0, 0x0F, 0x00, 0xFC, 0xC7, 0x8F, 0x3F, 0x00, 0xF8, 0x1F, 0x00, 0xFC, 0xE7, 0xCF, 0x3F, 0x00, 0x1C, 0x3C, 0x00, 0xFC, 0xE7, 0xFF, 0x3F, 0x00, 0x0E, 0x78, 0x00, 0xFC, 0xE7, 0xFF, 0x3F, 0x00, 0x0E, 0x70, 0x00, 0xFC, 0xE7, 0xFF, 0x7F, 0x00, 0x07, 0xF0, 0x00, 0xFE, 0xE7, 0xFF, 0x7F, 0x00, 0x07, 0xE0, 0x00, 0xFE, 0xE3, 0xFE, 0x7F, 0x00, 0x0F, 0xF0, 0x00, 0xFE, 0x63, 0xFE, 0xFF, 0x00, 0x0E, 0x70, 0x00, 0xFF, 0x73, 0xFE, 0xFF, 0x00, 0x1E, 0x78, 0x00, 0xFF, 0x71, 0xFE, 0xFF, 0x01, 0x7C, 0x3E, 0x80, 0xFF, 0x71, 0xFC, 0xFF, 0x01, 0xF8, 0x1F, 0x80, 0xFF, 0x39, 0xFC, 0xFF, 0x03, 0xE0, 0x07, 0xC0, 0xFF, 0x38, 0xF8, 0xFF, 0x07, 0x00, 0x00, 0xE0, 0xFF, 0x1C, 0xF8, 0xFF, 0x0F, 0x00, 0x00, 0xF0, 0x7F, 0x1C, 0xF8, 0xFF, 0x1F, 0x00, 0x00, 0xF8, 0x3F, 0x1E, 0xF0, 0xFF, 0x7F, 0x00, 0x00, 0xFE, 0x3F, 0x0F, 0xE0, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0x07, 0xE0, 0xFF, 0xFF, 0x0F, 0xF0, 0xFF, 0xFF, 0x07, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00]).buffer;
var ball8thinking = new Uint8Array([0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x3F, 0xC0, 0xFF, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0x3F, 0x00, 0xFE, 0x03, 0x00, 0x00, 0xE0, 0xFF, 0x7F, 0x00, 0xF8, 0x07, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0x1F, 0xE0, 0x1F, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x80, 0x3F, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0x03, 0x7F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xFC, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xF8, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xF0, 0x01, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE1, 0x03, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x87, 0x07, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFC, 0xFF, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFC, 0xF8, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0xF8, 0xE1, 0xFF, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0xE0, 0x03, 0xFF, 0xFF, 0xFF, 0x07, 0x00, 0x00, 0xC0, 0x0F, 0xF8, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFC, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x01, 0xFC, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFE, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x3F, 0x00, 0x00, 0x00]).buffer;

var affirmative = ["It is certain", "It is decidedly so", "Without a doubt", "Yes definitely", "You may rely on it", "As I see it, yes", "Most likely", "Outlook good", "Yes", "Signs point to yes"];
var nonCommittal = ["Reply hazy, try again", "Ask again later", "Better not tell you now", "Cannot predict now", "Concentrate and ask again"];
var negative = ["Don't count on it", "My reply is no", "My sources say no", "Outlook not so good", "Very doubtful"];
var allAnswers = affirmative.concat(nonCommittal, negative);

function getRandomAnswer() {
    return allAnswers[Math.floor(Math.random() * allAnswers.length)];
}

function drawTitle() {
    display.fill(bgColor);
    display.drawRoundRect(1, 1, displayWidth - 2, displayHeight - 2, 4, priColor);
    display.setTextColor(priColor);
    display.setTextSize(2);
    var title = "Magic 8 Ball";
    var charWidth = 6 * 2;
    var x = (displayWidth - title.length * charWidth) / 2;
    display.drawString(title, x, 10);
    display.setTextSize(1);
}

function drawBall8(image) {
    var BALL_SIZE = 64;
    var x = Math.round(displayWidth * 0.2 - BALL_SIZE / 2);
    var y = Math.round((displayHeight - BALL_SIZE) / 2);
    display.drawXBitmap(x, y, image, BALL_SIZE, BALL_SIZE, priColor, bgColor);
    return {x: x, y: y, size: BALL_SIZE};
}

function pressSelForNext() {
    display.setTextSize(1);
    var msg = "Press SEL for next";
    var charWidth = 6; // size 1
    var rightMargin = 10;
    var bottomMargin = 20;
    var x = displayWidth - rightMargin - msg.length * charWidth;
    var y = displayHeight - bottomMargin;
    display.drawString(msg, x, y);
}

function showInstructions() {
    drawTitle();
    var b = drawBall8(ball8);
    display.setTextSize(3);
    var line1 = "Ask a";
    var line2 = "question";
    var charWidth = 6 * 3;
    var lineHeight = 24; // approximate height for size 3
    var totalHeight = lineHeight * 2;
    var startY = b.y + Math.round((b.size - totalHeight) / 2);
    var textX = Math.min(b.x + b.size + 12,
        displayWidth - 10 - Math.max(line1.length, line2.length) * charWidth);
    display.drawString(line1, textX, startY);
    display.drawString(line2, textX, startY + lineHeight);
    pressSelForNext();
}

function showThinking() {
    drawTitle();
    var b = drawBall8(ball8thinking);
    display.setTextSize(3);
    var textX = Math.min(b.x + b.size + 12, displayWidth - 180);
    var textY = b.y + Math.round((b.size - 24) / 2); // roughly centered vertically beside ball
    display.drawString("Thinking...", textX, textY);
}

function showAnswer(answer) {
    drawTitle();
    var b = drawBall8(ball8);

    var FONT_SIZE = 3;
    display.setTextSize(FONT_SIZE);

    var margin = 12;
    var textX = Math.min(b.x + b.size + margin, displayWidth - 20);
    var availableWidth = Math.max(0, displayWidth - textX - 10);

    var charWidth = 6 * FONT_SIZE;
    var lineHeight = 8 * FONT_SIZE; // ~24 for size 3
    var maxCharsPerLine = Math.max(1, Math.floor(availableWidth / charWidth));

    var words = answer.split(' ');
    var lines = [];
    var current = "";
    for (var i = 0; i < words.length; i++) {
        var test = current ? (current + " " + words[i]) : words[i];
        if (test.length > maxCharsPerLine && current) {
            lines.push(current);
            current = words[i];
        } else {
            current = test;
        }
    }
    if (current) lines.push(current);

    var totalHeight = lines.length * lineHeight;
    var startY = b.y + Math.max(0, Math.round((b.size - totalHeight) / 2));

    for (var l = 0; l < lines.length; l++) {
        display.drawString(lines[l], textX, startY + l * lineHeight);
    }

    pressSelForNext();
}

showInstructions();

while (true) {
    if (getSelPress()) {
        showThinking();
        delay(1000);
        var answer = getRandomAnswer();
        showAnswer(answer);
        while (!getSelPress()) {
            if (getEscPress()) break;
            delay(100);
        }
        if (getEscPress()) break;
        showInstructions();
    }
    if (getEscPress()) break;
    delay(100);
}